<!DOCTYPE html>
<html lang="en" ng-app="chessApp">
    <head>
        <title>UChess Angular</title>
        <link rel="shortcut icon" type="image/png" href="@routes.Assets.versioned("images/favicon.png")">
 
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
		
		<style>
		    .field {
                display: block;
		        float: left;
		        width:  5%;
		        height: 5%;
                margin: 0px;
		    }
		</style>
		<!-- Latest compiled and minified JavaScript -->
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js"></script>
    	<script>   
		    var i = 1;
		    var endpos = "";
		    var str1 = "";
		
		    var chessApp = angular.module('chessApp', []);
		    chessApp.controller('ChessCtrl', function ($scope){
		    	$scope.figures = [];
		    	$scope.enableRestart = false;
		    	var address = window.location.origin.replace("http", "ws");
		    	var $socket = new WebSocket(address + "/socket");
		        $socket.onopen = function(){};
				$socket.onmessage = function(message){ 			
					switch(message.data) {
						case "WAIT":
							$scope.status = "Waiting for opponent!";
							break;
						case "QUIT":
							$socket.close();
							if(confirm("Your opponent left the game! Go back to home.")){
								window.location = '/';
							}
							break;
						case "WINNER black":
						case "WINNER white":
							alert(message.data.substr(message.data.length - 5) + " has won the game");
							break;
						case "black":
							$scope.status = "It´s Black Turn";
							break;
						case "white":
							$scope.status = "It´s White Turn";
							break;
						default:
							var msg = JSON.parse(message.data);
							$scope.figures = msg.figures;
							$scope.$apply();
					}
		        }; 
		        $socket.onerror = function(){
		        	alert("Error occurred!");
		        };  
		        $socket.onclose = function(){};
		    		
// 		        angular.element(document).ready(function () {
// 		        	$scope.$apply();
// 		        });
				
				$scope.reset = function() {
		        	$socket.send("RESET"); 	
		        };
		        
		    	$scope.move = function(pos) {
		    		if(i == 1) {
			    		str1 = pos;
			    		$scope.click = "1 Feld gedrueckt";
					} else if(i == 2) {
						endpos = str1 + " " + pos;
		    			console.log("send pos " + endpos);
		    			$socket.send(endpos);
		    			i = 0;
		    			str1 = "";
		    			endpos = "";
		    			$scope.click = "0 Felder gedrueckt";
		    		}
					i = i + 1;
		        };            
		    });
    	</script>   
    </head>
    <body ng-controller="ChessCtrl">
    	<ul>
    		<span ng-repeat="figur in figures">
	    		<div ng-if="($index % 8) == 0" class="row"></div>
	    		<img ng-src="/assets/images/{{figur.color}}{{figur.figure}}{{figur.bg}}.jpg" ng-click="move(figur.pos)" class="field"/>
    		</span>
    	</ul>
    	<div id="control">
    		<label for="status">Status: </label><span id="status">{{status}}</span><br />
    		<label for="click">Clicks: </label><span id="click">{{click}}</span><br />
    		<button id="resetB" ng-click="reset()" ng-if="enableRestart">Gegner erneut herausfordern!</button> 
    	</div>
    </body>
</html>
